name: Test Coverage
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Setup cargo-llvm-cov with isolated caching
  setup-cargo-llvm-cov:
    name: Setup Cargo LLVM Coverage
    uses: ./.github/workflows/cargo-llvm-cov-setup.yml
    with:
      cache-key: "coverage"

  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: [setup-cargo-llvm-cov]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo-llvm-cov installation
        id: cache-cargo-llvm-cov
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cargo-llvm-cov
          key: ${{ runner.os }}-cargo-llvm-cov-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-llvm-cov-coverage-
            ${{ runner.os }}-cargo-llvm-cov-
      - name: Install cargo-llvm-cov
        if: steps.cache-cargo-llvm-cov.outputs.cache-hit != 'true' || needs.setup-cargo-llvm-cov.outputs.cache-hit != 'true'
        run: cargo install cargo-llvm-cov --force
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-
      - name: Generate coverage report
        run: |
          # Generate coverage for all crates
          # Note: krox is excluded due to cross-language support issues
          cargo llvm-cov --workspace --lcov --output-path lcov.info --exclude-from-test krox

          # Generate HTML report
          cargo llvm-cov --workspace --html --output-dir coverage-html --exclude-from-test krox

          # Generate coverage summary
          cargo llvm-cov --workspace --text --exclude-from-test krox
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            lcov.info
            coverage-html/
          retention-days: 30

  load-crates:
    name: Load Crate Configuration
    uses: ./.github/workflows/shared-crates.yml

  crate-coverage:
    name: Crate Coverage
    runs-on: ubuntu-latest
    needs: [load-crates]
    strategy:
      matrix:
        crate: ${{ fromJSON(needs.load-crates.outputs.coverage-crates) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo-llvm-cov installation
        id: cache-cargo-llvm-cov
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cargo-llvm-cov
          key: ${{ runner.os }}-cargo-llvm-cov-${{ matrix.crate }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-llvm-cov-${{ matrix.crate }}-
            ${{ runner.os }}-cargo-llvm-cov-
      - name: Install cargo-llvm-cov
        if: steps.cache-cargo-llvm-cov.outputs.cache-hit != 'true'
        run: cargo install cargo-llvm-cov --force
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.crate }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.crate }}-
      - name: Generate coverage for ${{ matrix.crate }}
        run: |
          cargo llvm-cov --all-features --package ${{ matrix.crate }} --lcov --output-path lcov-${{ matrix.crate }}.info
          cargo llvm-cov --all-features --package ${{ matrix.crate }} --text
      - name: Upload crate coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.crate }}
          path: lcov-${{ matrix.crate }}.info
          retention-days: 30

  coverage-thresholds:
    name: Coverage Thresholds
    runs-on: ubuntu-latest
    needs: [coverage, load-crates]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo-llvm-cov installation
        id: cache-cargo-llvm-cov
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cargo-llvm-cov
          key: ${{ runner.os }}-cargo-llvm-cov-thresholds-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-llvm-cov-thresholds-
            ${{ runner.os }}-cargo-llvm-cov-
      - name: Install cargo-llvm-cov
        if: steps.cache-cargo-llvm-cov.outputs.cache-hit != 'true'
        run: cargo install cargo-llvm-cov --force
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
      - name: Check coverage thresholds
        run: |
          # Check overall coverage (should be >= 80%)
          cargo llvm-cov --all-features --workspace --text | grep "Total" | awk '{if ($2 < 80) exit 1}'

          echo "Coverage thresholds passed!"

  coverage-badges:
    name: Coverage Badges
    runs-on: ubuntu-latest
    needs: [coverage, load-crates]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo-llvm-cov installation
        id: cache-cargo-llvm-cov
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cargo-llvm-cov
          key: ${{ runner.os }}-cargo-llvm-cov-badges-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-llvm-cov-badges-
            ${{ runner.os }}-cargo-llvm-cov-
      - name: Install cargo-llvm-cov
        if: steps.cache-cargo-llvm-cov.outputs.cache-hit != 'true'
        run: cargo install cargo-llvm-cov --force
      - name: Generate coverage percentage
        id: coverage
        run: |
          COVERAGE=$(cargo llvm-cov --all-features --workspace --text | grep "Total" | awk '{print $2}' | sed 's/%//')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
      - name: Generate coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: your-gist-id-here
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.coverage }}%
          namedLogo: rust
          color: ${{ steps.coverage.outputs.coverage >= 90 && 'brightgreen' || steps.coverage.outputs.coverage >= 80 && 'green' || steps.coverage.outputs.coverage >= 70 && 'yellow' || 'red' }}
